import express from "express";
import fs from "fs";
import path from "path";
import { chromium } from "playwright";

const app = express();
app.use(express.json());

const PORT = 3001;
const DEBUG_DIR = path.join(process.cwd(), "debug");
const CACHE_FILE = path.join(process.cwd(), "cache.json");

if (!fs.existsSync(DEBUG_DIR)) fs.mkdirSync(DEBUG_DIR, { recursive: true });

// --- Simple in-memory cache (also persisted to cache.json) ---
let cache = {
  generatedAt: null,
  source: {
    id: "abc",
    name: "ABC News",
    homeUrl: "https://abcnews.go.com/",
    updatedAt: null,
    ok: false,
    error: "Not refreshed yet",
    items: [],
  },
};

// Load last cache on startup (optional but nice)
try {
  if (fs.existsSync(CACHE_FILE)) {
    cache = JSON.parse(fs.readFileSync(CACHE_FILE, "utf8"));
  }
} catch (_) {
  // ignore
}

// ---- Helpers ----
function nowISO() {
  return new Date().toISOString();
}

function normalizeUrl(u) {
  try {
    const url = new URL(u);
    // strip common tracking params
    for (const key of [...url.searchParams.keys()]) {
      if (key.toLowerCase().startsWith("utm_")) url.searchParams.delete(key);
    }
    // optional: drop most query params entirely (uncomment if you prefer)
    // url.search = "";
    return url.toString();
  } catch {
    return u;
  }
}

function cleanTitle(t) {
  return String(t || "")
    .replace(/\s+/g, " ")
    .replace(/\u00A0/g, " ")
    .trim();
}

function isJunkLink(urlStr, title) {
  const u = urlStr.toLowerCase();
  const t = (title || "").toLowerCase();
  const junkHints = [
    "subscribe",
    "sign in",
    "signin",
    "log in",
    "login",
    "newsletter",
    "watch",
    "live",
    "podcast",
    "shop",
  ];
  if (junkHints.some((h) => u.includes(h) || t.includes(h))) return true;

  // Keep it strict: only keep abcnews story-ish links
  if (!u.includes("abcnews.go.com")) return true;

  return false;
}

// ---- ABC scraper: Top Stories ----
async function scrapeABCTopStories(x = 15) {
  const browser = await chromium.launch({ headless: true });
  const page = await browser.newPage({ viewport: { width: 1280, height: 720 } });

  const debugHtml = path.join(DEBUG_DIR, "abc.html");
  const debugPng = path.join(DEBUG_DIR, "abc.png");

  try {
    await page.goto("https://abcnews.go.com/", { waitUntil: "domcontentloaded", timeout: 45000 });

    // A small wait can help stabilize late-loading modules
    await page.waitForTimeout(1500);

    // Find a container near the "Top Stories" heading.
    // Strategy:
    // - locate the text "Top Stories"
    // - walk up to a reasonable section ancestor
    // - then collect story links inside it
    const topStoriesHeading = page.getByText("Top Stories", { exact: false }).first();
    await topStoriesHeading.waitFor({ timeout: 15000 });

    // Climb to a section-ish ancestor to scope the query.
    // We use evaluateHandle to traverse DOM parents.
    const sectionHandle = await topStoriesHeading.evaluateHandle((node) => {
      let el = node;
      // climb a few levels; stop on a semantic-ish container if found
      for (let i = 0; i < 8 && el; i++) {
        if (el.tagName && ["SECTION", "DIV", "MAIN", "ASIDE"].includes(el.tagName)) {
          // Heuristic: pick the first ancestor that contains multiple links
          const links = el.querySelectorAll("a");
          if (links && links.length >= 5) return el;
        }
        el = el.parentElement;
      }
      return node.parentElement || node;
    });

    // Pull anchors within that container in DOM order
    const raw = await sectionHandle.evaluate((section) => {
      const anchors = Array.from(section.querySelectorAll("a"));
      return anchors.map((a) => ({
        href: a.getAttribute("href") || "",
        text: (a.textContent || "").trim(),
      }));
    });

    // Normalize, filter, dedupe, rank
    const seen = new Set();
    const items = [];
    for (const a of raw) {
      const title = cleanTitle(a.text);
      if (!title || title.length < 8) continue;

      let href = a.href;
      if (!href) continue;

      // Make absolute if relative
      try {
        href = new URL(href, "https://abcnews.go.com/").toString();
      } catch {
        continue;
      }
      href = normalizeUrl(href);

      if (isJunkLink(href, title)) continue;

      const key = href;
      if (seen.has(key)) continue;
      seen.add(key);

      items.push({ title, url: href });
      if (items.length >= x) break;
    }

    // If we got too few, fail loudly so you see it and adjust selector.
    if (items.length < Math.min(5, x)) {
      throw new Error(`Too few items extracted (${items.length}). Selector scope likely wrong.`);
    }

    return {
      ok: true,
      error: null,
      updatedAt: nowISO(),
      items: items.map((it, idx) => ({ rank: idx + 1, ...it })),
    };
  } catch (err) {
    // Dump debug artifacts
    try {
      fs.writeFileSync(debugHtml, await page.content(), "utf8");
      await page.screenshot({ path: debugPng, fullPage: true });
    } catch (_) {}

    return {
      ok: false,
      error: err?.message || String(err),
      updatedAt: nowISO(),
      items: [],
    };
  } finally {
    await page.close().catch(() => {});
    await browser.close().catch(() => {});
  }
}

// ---- API ----
app.get("/api/headlines", (req, res) => {
  res.json(cache);
});

app.post("/api/refresh", async (req, res) => {
  const x = Number(req.body?.x ?? 15);
  const result = await scrapeABCTopStories(Number.isFinite(x) ? x : 15);

  // Update cache (keep last-good items if scrape fails)
  const prevItems = cache.source.items || [];
  cache.generatedAt = nowISO();
  cache.source = {
    ...cache.source,
    updatedAt: result.updatedAt,
    ok: result.ok,
    error: result.error,
    items: result.ok ? result.items : prevItems,
    stale: !result.ok,
  };

  fs.writeFileSync(CACHE_FILE, JSON.stringify(cache, null, 2), "utf8");
  res.json(cache);
});

app.listen(PORT, () => {
  console.log(`API running on http://localhost:${PORT}`);
  console.log(`Try: curl -X POST http://localhost:${PORT}/api/refresh -H "Content-Type: application/json" -d '{"x":15}'`);
});
